import{j as n}from"./jsx-runtime-B0wN4eWF.js";import{r as R}from"./index-BLsgEXh-.js";import{i as N}from"./index-CbuwW4_d.js";import"./usePrefix-DVhi0s40.js";import{O as T,a as D}from"./index-CLdR1d0e.js";import{u as M,a as I}from"./index-CfoIBI3E.js";import{S as C}from"./StatusIcon-CsvDFwWU.js";import{S as j}from"./Step-C5G7DejP.js";import{f as w}from"./bucket-3-igrvqujs.js";import{a as v}from"./bucket-12-DVDhO4p7.js";class k extends R.Component{state={hasWarning:!1,selectedStepId:null};componentDidMount(){this.selectDefaultStep(),this.getStepData({propagateWarning:!0})}componentDidUpdate(e){const{reason:t}=this.props;e.reason!==t&&t==="Succeeded"&&this.getStepData({propagateWarning:!0})}getStepData({propagateWarning:e=!1}={}){const{reason:t,selectedStepId:a,steps:r}=this.props;let i=!1;const l=M(r).map(o=>{const{name:u,terminationReason:p}=o,{exitCode:c,status:h,reason:d}=I(o);return d==="Completed"&&(i=i||c!==0),{exitCode:c,name:u,selected:a===u,stepReason:d,stepStatus:t==="TaskRunCancelled"&&h!=="terminated"?"cancelled":h,terminationReason:p}});return e&&this.setState({hasWarning:i}),l}handleClick=()=>{const{id:e,selectedRetry:t,taskRun:a}=this.props,{selectedStepId:r}=this.state;this.props.onSelect({selectedRetry:t,selectedStepId:r,selectedTaskId:e,taskRunName:a.metadata?.name})};handleStepSelected=e=>{this.setState({selectedStepId:e},()=>{this.handleClick()})};handleTaskSelected=e=>{e?.preventDefault(),this.setState({selectedStepId:null},()=>{this.handleClick()})};selectDefaultStep(){const{expanded:e,selectDefaultStep:t,selectedStepId:a,steps:r}=this.props;if(t&&e&&!a){const i=r.find(o=>o.terminated?.reason==="Error"||!o.terminated),{name:l}=i||r[0]||{};this.handleStepSelected(l)}}render(){const{displayName:e,expanded:t,intl:a,onRetryChange:r,reason:i,selectedRetry:l,selectedStepId:o,succeeded:u,taskRun:p}=this.props,{hasWarning:c}=this.state,h=t?null:n.jsx(w,{size:20,className:"tkn--task--expand-icon"});let d,m;return(l||p.status?.retriesStatus)&&(m=a.formatMessage({id:"dashboard.pipelineRun.retries.view",defaultMessage:"View retries"}),l==="0"?d=a.formatMessage({id:"dashboard.pipelineRun.pipelineTaskName.firstAttempt",defaultMessage:"{pipelineTaskName} (first attempt)"},{pipelineTaskName:e}):d=a.formatMessage({id:"dashboard.pipelineRun.pipelineTaskName.retry",defaultMessage:"{pipelineTaskName} (retry {retryNumber, number})"},{pipelineTaskName:e,retryNumber:l||p.status.retriesStatus.length})),n.jsxs("li",{className:"tkn--task","data-active":t||void 0,"data-has-warning":c,"data-reason":i,"data-succeeded":u,"data-selected":t&&!o||void 0,children:[n.jsxs("span",{className:"tkn--task-link",tabIndex:0,title:d||e,onClick:this.handleTaskSelected,onKeyUp:s=>s.key==="Enter"&&this.handleTaskSelected(s),role:"button",children:[n.jsx(C,{DefaultIcon:s=>n.jsx(v,{size:20,...s}),hasWarning:c,reason:i,status:u}),n.jsx("span",{className:"tkn--task-link--name",children:d||e}),t&&p.status?.retriesStatus?n.jsx(T,{"aria-label":m,iconDescription:m,menuOptionsClass:"tkn--task--retries-menu-options",selectorPrimaryFocus:"button:not([disabled])",size:"sm",title:m,children:p.status.retriesStatus.map((s,f)=>({id:f,text:f===0?a.formatMessage({id:"dashboard.pipelineRun.retries.viewFirstAttempt",defaultMessage:"View first attempt"}):a.formatMessage({id:"dashboard.pipelineRun.retries.viewRetry",defaultMessage:"View retry {retryNumber, number}"},{retryNumber:f})})).concat([{id:"",text:a.formatMessage({id:"dashboard.pipelineRun.retries.viewLatestRetry",defaultMessage:"View latest retry"})}]).map(s=>n.jsx(D,{disabled:`${s.id}`===l,itemText:s.text,onClick:()=>r(s.id),requireTitle:!0},s.text))}):null,h]}),t&&n.jsx("ol",{className:"tkn--step-list",children:this.getStepData().map(s=>{const{exitCode:f,name:S,selected:g,stepReason:x,stepStatus:y,terminationReason:b}=s;return n.jsx(j,{exitCode:f,id:S,onSelect:this.handleStepSelected,reason:x,selected:g,status:y,stepName:S,terminationReason:b},S)})})]})}}k.defaultProps={steps:[]};const $=N(k);k.__docgenInfo={description:"",methods:[{name:"getStepData",docblock:null,modifiers:[],params:[{name:"{ propagateWarning = false }",optional:!0,type:null}],returns:null},{name:"handleClick",docblock:null,modifiers:[],params:[],returns:null},{name:"handleStepSelected",docblock:null,modifiers:[],params:[{name:"selectedStepId",optional:!1,type:null}],returns:null},{name:"handleTaskSelected",docblock:null,modifiers:[],params:[{name:"event",optional:!1,type:null}],returns:null},{name:"selectDefaultStep",docblock:null,modifiers:[],params:[],returns:null}],displayName:"Task",props:{steps:{defaultValue:{value:"[]",computed:!1},required:!1}}};export{$ as T};
